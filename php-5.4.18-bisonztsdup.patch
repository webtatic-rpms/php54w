diff -ru php-5.4.18-bisonztsdup/Zend/zend_language_parser.c php-5.4.18/Zend/zend_language_parser.c
--- php-5.4.18-bisonztsdup/Zend/zend_language_parser.c	2013-08-14 06:04:57.000000000 +0000
+++ php-5.4.18/Zend/zend_language_parser.c	2013-08-18 13:41:29.923345787 +0000
@@ -113,11 +113,6 @@
 
 #define YYERROR_VERBOSE
 #define YYSTYPE znode
-#ifdef ZTS
-# define YYPARSE_PARAM tsrm_ls
-# define YYLEX_PARAM tsrm_ls
-#endif
-
 
 
 
@@ -149,6 +144,16 @@
 #if YYDEBUG
 extern int zenddebug;
 #endif
+/* "%code requires" blocks.  */
+
+
+#ifdef ZTS
+# define YYPARSE_PARAM tsrm_ls
+# define YYLEX_PARAM tsrm_ls
+#endif
+
+
+
 
 /* Tokens.  */
 #ifndef YYTOKENTYPE
@@ -961,58 +966,58 @@
 /* YYRLINE[YYN] -- source line where rule number YYN was defined.  */
 static const yytype_uint16 yyrline[] =
 {
-       0,   214,   214,   218,   218,   219,   223,   224,   228,   229,
-     230,   231,   232,   233,   233,   235,   235,   237,   238,   242,
-     243,   247,   248,   249,   250,   254,   255,   259,   259,   260,
-     265,   266,   267,   268,   273,   274,   278,   279,   279,   279,
-     280,   280,   280,   281,   281,   281,   282,   282,   282,   286,
-     288,   290,   283,   292,   292,   293,   294,   295,   296,   297,
-     298,   299,   300,   301,   302,   303,   304,   305,   307,   308,
-     306,   311,   312,   310,   314,   314,   315,   316,   317,   318,
-     319,   320,   316,   322,   323,   328,   329,   333,   334,   339,
-     339,   339,   344,   345,   349,   353,   357,   362,   363,   368,
-     368,   374,   373,   380,   379,   389,   390,   391,   392,   396,
-     397,   401,   404,   406,   409,   411,   415,   416,   420,   421,
-     426,   427,   431,   432,   437,   438,   443,   444,   449,   450,
-     455,   456,   457,   458,   463,   464,   464,   465,   465,   470,
-     471,   476,   477,   482,   484,   484,   488,   490,   490,   494,
-     496,   500,   502,   507,   508,   513,   514,   515,   516,   517,
-     518,   519,   520,   525,   526,   527,   528,   533,   534,   539,
-     540,   541,   542,   543,   544,   548,   549,   554,   555,   556,
-     561,   562,   563,   564,   570,   571,   576,   576,   577,   578,
-     579,   579,   584,   588,   589,   593,   594,   597,   599,   603,
-     604,   608,   609,   613,   617,   618,   622,   623,   627,   631,
-     632,   636,   637,   641,   642,   646,   647,   651,   652,   656,
-     657,   661,   662,   663,   664,   665,   666,   670,   671,   672,
-     673,   677,   678,   682,   683,   688,   689,   693,   693,   694,
-     698,   699,   703,   704,   708,   708,   709,   710,   714,   715,
-     715,   720,   720,   724,   724,   725,   726,   727,   727,   728,
-     729,   730,   731,   732,   733,   734,   735,   736,   737,   738,
-     739,   740,   741,   742,   743,   744,   744,   745,   745,   746,
-     746,   747,   747,   748,   749,   750,   751,   752,   753,   754,
-     755,   756,   757,   758,   759,   760,   761,   762,   763,   764,
-     765,   766,   767,   768,   769,   770,   771,   772,   773,   774,
-     775,   775,   776,   777,   776,   779,   779,   781,   782,   783,
-     784,   785,   786,   787,   788,   789,   790,   790,   791,   792,
-     793,   794,   795,   796,   796,   798,   798,   803,   806,   808,
-     812,   813,   814,   815,   819,   819,   822,   822,   825,   825,
-     828,   828,   831,   831,   834,   834,   837,   837,   840,   840,
-     846,   847,   848,   849,   853,   854,   855,   861,   862,   867,
-     868,   867,   870,   875,   876,   881,   885,   886,   887,   891,
-     892,   893,   898,   899,   904,   905,   906,   907,   908,   909,
-     910,   911,   912,   913,   914,   915,   920,   921,   922,   923,
-     924,   925,   926,   927,   928,   929,   933,   937,   938,   939,
-     940,   941,   942,   943,   944,   945,   950,   951,   954,   956,
-     960,   961,   962,   963,   967,   968,   973,   978,   983,   988,
-     989,   988,   991,   995,   996,  1001,  1001,  1005,  1006,  1010,
-    1010,  1016,  1017,  1018,  1022,  1023,  1027,  1028,  1033,  1037,
-    1038,  1038,  1043,  1044,  1045,  1050,  1051,  1052,  1056,  1057,
-    1058,  1063,  1064,  1068,  1069,  1074,  1075,  1075,  1079,  1080,
-    1081,  1085,  1086,  1090,  1091,  1095,  1096,  1101,  1102,  1102,
-    1103,  1108,  1109,  1113,  1114,  1115,  1116,  1117,  1118,  1119,
-    1120,  1124,  1125,  1126,  1127,  1133,  1134,  1134,  1135,  1136,
-    1137,  1138,  1143,  1144,  1145,  1150,  1151,  1152,  1153,  1154,
-    1155,  1156,  1160,  1161,  1161,  1165,  1166
+       0,   216,   216,   220,   220,   221,   225,   226,   230,   231,
+     232,   233,   234,   235,   235,   237,   237,   239,   240,   244,
+     245,   249,   250,   251,   252,   256,   257,   261,   261,   262,
+     267,   268,   269,   270,   275,   276,   280,   281,   281,   281,
+     282,   282,   282,   283,   283,   283,   284,   284,   284,   288,
+     290,   292,   285,   294,   294,   295,   296,   297,   298,   299,
+     300,   301,   302,   303,   304,   305,   306,   307,   309,   310,
+     308,   313,   314,   312,   316,   316,   317,   318,   319,   320,
+     321,   322,   318,   324,   325,   330,   331,   335,   336,   341,
+     341,   341,   346,   347,   351,   355,   359,   364,   365,   370,
+     370,   376,   375,   382,   381,   391,   392,   393,   394,   398,
+     399,   403,   406,   408,   411,   413,   417,   418,   422,   423,
+     428,   429,   433,   434,   439,   440,   445,   446,   451,   452,
+     457,   458,   459,   460,   465,   466,   466,   467,   467,   472,
+     473,   478,   479,   484,   486,   486,   490,   492,   492,   496,
+     498,   502,   504,   509,   510,   515,   516,   517,   518,   519,
+     520,   521,   522,   527,   528,   529,   530,   535,   536,   541,
+     542,   543,   544,   545,   546,   550,   551,   556,   557,   558,
+     563,   564,   565,   566,   572,   573,   578,   578,   579,   580,
+     581,   581,   586,   590,   591,   595,   596,   599,   601,   605,
+     606,   610,   611,   615,   619,   620,   624,   625,   629,   633,
+     634,   638,   639,   643,   644,   648,   649,   653,   654,   658,
+     659,   663,   664,   665,   666,   667,   668,   672,   673,   674,
+     675,   679,   680,   684,   685,   690,   691,   695,   695,   696,
+     700,   701,   705,   706,   710,   710,   711,   712,   716,   717,
+     717,   722,   722,   726,   726,   727,   728,   729,   729,   730,
+     731,   732,   733,   734,   735,   736,   737,   738,   739,   740,
+     741,   742,   743,   744,   745,   746,   746,   747,   747,   748,
+     748,   749,   749,   750,   751,   752,   753,   754,   755,   756,
+     757,   758,   759,   760,   761,   762,   763,   764,   765,   766,
+     767,   768,   769,   770,   771,   772,   773,   774,   775,   776,
+     777,   777,   778,   779,   778,   781,   781,   783,   784,   785,
+     786,   787,   788,   789,   790,   791,   792,   792,   793,   794,
+     795,   796,   797,   798,   798,   800,   800,   805,   808,   810,
+     814,   815,   816,   817,   821,   821,   824,   824,   827,   827,
+     830,   830,   833,   833,   836,   836,   839,   839,   842,   842,
+     848,   849,   850,   851,   855,   856,   857,   863,   864,   869,
+     870,   869,   872,   877,   878,   883,   887,   888,   889,   893,
+     894,   895,   900,   901,   906,   907,   908,   909,   910,   911,
+     912,   913,   914,   915,   916,   917,   922,   923,   924,   925,
+     926,   927,   928,   929,   930,   931,   935,   939,   940,   941,
+     942,   943,   944,   945,   946,   947,   952,   953,   956,   958,
+     962,   963,   964,   965,   969,   970,   975,   980,   985,   990,
+     991,   990,   993,   997,   998,  1003,  1003,  1007,  1008,  1012,
+    1012,  1018,  1019,  1020,  1024,  1025,  1029,  1030,  1035,  1039,
+    1040,  1040,  1045,  1046,  1047,  1052,  1053,  1054,  1058,  1059,
+    1060,  1065,  1066,  1070,  1071,  1076,  1077,  1077,  1081,  1082,
+    1083,  1087,  1088,  1092,  1093,  1097,  1098,  1103,  1104,  1104,
+    1105,  1110,  1111,  1115,  1116,  1117,  1118,  1119,  1120,  1121,
+    1122,  1126,  1127,  1128,  1129,  1135,  1136,  1136,  1137,  1138,
+    1139,  1140,  1145,  1146,  1147,  1152,  1153,  1154,  1155,  1156,
+    1157,  1158,  1162,  1163,  1163,  1167,  1168
 };
 #endif
 
diff -ru php-5.4.18-bisonztsdup/Zend/zend_language_parser.h php-5.4.18/Zend/zend_language_parser.h
--- php-5.4.18-bisonztsdup/Zend/zend_language_parser.h	2013-08-14 06:04:57.000000000 +0000
+++ php-5.4.18/Zend/zend_language_parser.h	2013-08-18 13:41:29.924346245 +0000
@@ -39,6 +39,16 @@
 #if YYDEBUG
 extern int zenddebug;
 #endif
+/* "%code requires" blocks.  */
+
+
+#ifdef ZTS
+# define YYPARSE_PARAM tsrm_ls
+# define YYLEX_PARAM tsrm_ls
+#endif
+
+
+
 
 /* Tokens.  */
 #ifndef YYTOKENTYPE
diff -ru php-5.4.18-bisonztsdup/Zend/zend_language_parser.y php-5.4.18/Zend/zend_language_parser.y
--- php-5.4.18-bisonztsdup/Zend/zend_language_parser.y	2013-08-14 05:47:24.000000000 +0000
+++ php-5.4.18/Zend/zend_language_parser.y	2013-08-18 13:40:20.442612372 +0000
@@ -41,17 +41,19 @@
 
 #define YYERROR_VERBOSE
 #define YYSTYPE znode
-#ifdef ZTS
-# define YYPARSE_PARAM tsrm_ls
-# define YYLEX_PARAM tsrm_ls
-#endif
-
 
 %}
 
 %pure_parser
 %expect 3
 
+%code requires {
+#ifdef ZTS
+# define YYPARSE_PARAM tsrm_ls
+# define YYLEX_PARAM tsrm_ls
+#endif
+}
+
 %token END 0 "end of file"
 %left T_INCLUDE T_INCLUDE_ONCE T_EVAL T_REQUIRE T_REQUIRE_ONCE
 %token T_INCLUDE      "include (T_INCLUDE)"
